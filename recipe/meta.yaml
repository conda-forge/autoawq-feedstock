{% set name = "autoawq" %}
{% set version = "0.2.3" %}

package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  url: https://github.com/casper-hansen/{{ name }}/archive/refs/tags/v{{ version }}.tar.gz
  sha256: 01e2cb06bf3370553acbd85ca6fd00e99f43862947f137ea527c538dac1c4cc6

build:
  # noarch: python
  rpaths:
    - lib/
  script_env:
    - DISABLE_QIGEN=1 # coming soon
    - TORCH_CUDA_ARCH_LIST=3.5;5.0;6.0;6.1;7.0;7.5;8.0;8.6+PTX      # [cuda_compiler_version == "11.2"]
    - TORCH_CUDA_ARCH_LIST=3.5;5.0;6.0;6.1;7.0;7.5;8.0;8.6;8.9+PTX  # [cuda_compiler_version == "11.8"]
    - TORCH_CUDA_ARCH_LIST=5.0;6.0;6.1;7.0;7.5;8.0;8.6;8.9;9.0+PTX  # [(cuda_compiler_version or "").startswith("12")]
    - CPATH=${BUILD_PREFIX}/include
  script: |
    cat setup.py | sed 's/os.environ\["CC"\] = "g++"//' | sed 's/os.environ\["CXX"\] = "g++"//' > tmpsetup.py
    mv tmpsetup.py setup.py
    {{ PYTHON }} -m pip install . -vv --no-deps --no-build-isolation
  number: 0
  skip: true  # [cuda_compiler_version == "None"]
  skip: true  # [cuda_compiler_version == "11.2"]
  skip: true  # [osx or win]
  missing_dso_whitelist:
    - '*/libtorch_python.so'

requirements:
  build:
    - cmake
    - make
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - {{ compiler('cuda') }}

  host:
    - python
    - packaging
    - setuptools >=49.4.0
    - pytorch >=2.1.0
    - wheel
    - pip
    - libxcrypt
    - requests
  run:
    - python
    - pytorch
    - torchvision
    - transformers >=4.35.0
    - tokenizers >=0.12.1
    - accelerate
    - sentencepiece
    - lm_eval
    - texttable
    - toml
    - attributedict
    - protobuf
    - torchvision
    - tabulate
    - libtorch
    - requests

test:
  imports:
    - awq
  commands:
    - pip check
  requires:
    - pip

about:
  home: https://github.com/casper-hansen/AutoAWQ
  summary: AutoAWQ is an easy-to-use package for 4-bit quantized models.
  license: MIT
  license_file: LICENSE

extra:
  recipe-maintainers:
    - mediocretech
